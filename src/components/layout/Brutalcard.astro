---
interface Props {
    tone?: "red" | "orange" | "yellow" | "blue" | "black" | "green" | "purple" | "pink" | "gray" | "cyan";
    color?: string;
    textColor?: string;
    borderColor?: string;
    shadowColor?: string;
    class?: string;
    [key: string]: any;
}

interface PaletteEntry {
    bg: string;
    text: string;
    border: string;
    shadow: string;
}

// Enhanced palette with expanded neobrutalist colors
const palette: Record<NonNullable<Props["tone"]>, PaletteEntry> = {
    red: {
        bg: "#ff6b6b",
        text: "#111827",
        border: "#111827",
        shadow: "#111827",
    },
    orange: {
        bg: "#ffa94d",
        text: "#111827",
        border: "#111827",
        shadow: "#111827",
    },
    yellow: {
        bg: "#ffef5c",
        text: "#111827",
        border: "#111827",
        shadow: "#111827",
    },
    blue: {
        bg: "#5fb5ff",
        text: "#0f172a",
        border: "#0f172a",
        shadow: "#0f172a",
    },
    black: {
        bg: "#111827",
        text: "#f9fafc",
        border: "#05070a",
        shadow: "#ffef5c",
    },
    green: {
        bg: "#10b981",
        text: "#111827",
        border: "#111827",
        shadow: "#111827",
    },
    purple: {
        bg: "#8b5cf6",
        text: "#ffffff",
        border: "#6d28d9",
        shadow: "#6d28d9",
    },
    pink: {
        bg: "#ec4899",
        text: "#ffffff",
        border: "#be185d",
        shadow: "#be185d",
    },
    gray: {
        bg: "#6b7280",
        text: "#ffffff",
        border: "#374151",
        shadow: "#374151",
    },
    cyan: {
        bg: "#06b6d4",
        text: "#ffffff",
        border: "#0891b2",
        shadow: "#0891b2",
    },
};

// Helper function to determine if color is light or dark
function isLightColor(hexColor: string): boolean {
    const hex = hexColor.replace('#', '');
    const r = parseInt(hex.substr(0, 2), 16);
    const g = parseInt(hex.substr(2, 2), 16);
    const b = parseInt(hex.substr(4, 2), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness > 128;
}

// Helper function to darken a color
function darkenColor(hexColor: string, percent: number): string {
    const hex = hexColor.replace('#', '');
    const r = Math.max(0, parseInt(hex.substr(0, 2), 16) * (1 - percent / 100));
    const g = Math.max(0, parseInt(hex.substr(2, 2), 16) * (1 - percent / 100));
    const b = Math.max(0, parseInt(hex.substr(4, 2), 16) * (1 - percent / 100));
    return `#${Math.round(r).toString(16).padStart(2, '0')}${Math.round(g).toString(16).padStart(2, '0')}${Math.round(b).toString(16).padStart(2, '0')}`;
}

const {
    tone = "red",
    color,
    textColor: customTextColor,
    borderColor: customBorderColor,
    shadowColor: customShadowColor,
    class: className = "",
    ...rest
} = Astro.props as Props;

const { bg: toneBg, text: toneText, border: toneBorder, shadow: toneShadow } = palette[tone];

// Determine final colors
const bg = color ? color.toLowerCase() : toneBg;

// Auto-determine text color if not provided
const textColor = customTextColor ?? (color ? (isLightColor(color) ? '#111827' : '#ffffff') : toneText);

// Auto-determine border color if not provided
const borderColor = customBorderColor ?? (color ? darkenColor(color, 20) : toneBorder);

// Auto-determine shadow color if not provided
const shadowColor = customShadowColor ?? (color ? darkenColor(color, 40) : toneShadow);
---

<style define:vars={{ bg, borderColor, shadowColor, textColor }}>
    .brutal-card {
        position: relative;
        background-color: var(--bg);
        color: var(--textColor);
        border-radius: 0.5rem;
        border: 2px solid var(--borderColor);
        filter: drop-shadow(4px 4px 0 var(--shadowColor));
        transition: filter 0.2s ease, transform 0.2s ease;
        transform: translateY(0);
        padding: clamp(1.25rem, 1.5vw + 1rem, 1.75rem);
    }
    .brutal-card:hover {
        filter: drop-shadow(2px 2px 0 var(--shadowColor));
        transform: translateY(-2px);
    }

    .brutal-card.is-subtle {
        filter: drop-shadow(2px 2px 0 var(--shadowColor));
        padding: clamp(1.125rem, 1.25vw + 0.875rem, 1.5rem);
    }

    .brutal-card.is-flat {
        filter: none;
        padding: clamp(1rem, 1vw + 0.75rem, 1.375rem);
    }

    /* Make links inherit contrast inside dark cards */
    .brutal-card a {
        color: inherit;
    }

    /* iOS stability */
    @supports (-webkit-touch-callout: none) {
        .brutal-card {
            -webkit-transform: translateZ(0);
            backface-visibility: hidden;
            will-change: filter;
        }
    }
</style>

<div class={`brutal-card ${className}`} {...rest}>
    <slot />
</div>